{% extends "base.html" %}
{% macro render_pagination(pagination) %}
<!-- app/templates/macros/pagination.html -->
{% macro render_pagination(pagination, endpoint) %}
  <nav aria-label="Page navigation" class="mb-8 fade-in">
    <ul class="pagination justify-content-center space-x-1">
      {% if pagination.has_prev %}
        <li class="page-item">
          <a class="page-link rounded-l-lg px-4 py-2.5 border border-neutral-300 bg-white text-sm font-medium text-neutral-600 hover:bg-neutral-50 hover:border-primary hover:text-primary transition-colors" href="{{ url_for(endpoint, page=pagination.prev_num, **kwargs) }}">
            <i class="fa fa-angle-left"></i>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link rounded-l-lg px-4 py-2.5 border border-neutral-300 bg-white text-sm font-medium text-neutral-300 cursor-not-allowed">
            <i class="fa fa-angle-left"></i>
          </span>
        </li>
      {% endif %}
      {%- for page in pagination.iter_pages() %}
        {% if page %}
          {% if page != pagination.page %}
            <li class="page-item">
              <a class="page-link px-4 py-2.5 border border-neutral-300 bg-white text-sm font-medium text-neutral-600 hover:bg-neutral-50 hover:border-primary hover:text-primary transition-colors" href="{{ url_for(endpoint, page=page, **kwargs) }}">{{ page }}</a>
            </li>
          {% else %}
            <li class="page-item active">
              <span class="page-link px-4 py-2.5 border border-primary bg-primary text-white text-sm font-medium">{{ page }}</span>
            </li>
          {% endif %}
        {% else %}
          <li class="page-item disabled">
            <span class="page-link px-4 py-2.5 border border-neutral-300 bg-white text-sm font-medium text-neutral-300">...</span>
          </li>
        {% endif %}
      {%- endfor %}
      {% if pagination.has_next %}
        <li class="page-item">
          <a class="page-link rounded-r-lg px-4 py-2.5 border border-neutral-300 bg-white text-sm font-medium text-neutral-600 hover:bg-neutral-50 hover:border-primary hover:text-primary transition-colors" href="{{ url_for(endpoint, page=pagination.next_num, **kwargs) }}">
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link rounded-r-lg px-4 py-2.5 border border-neutral-300 bg-white text-sm font-medium text-neutral-300 cursor-not-allowed">
            <i class="fa fa-angle-right"></i>
          </span>
        </li>
      {% endif %}
    </ul>
  </nav>
{% endmacro %}
{% endmacro %}
{% block head %}
    {{ super() }}
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- 自定义Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6', // 更柔和的蓝色作为主色调
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        neutral: {
                            50: '#F9FAFB',
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                            300: '#D1D5DB',
                            400: '#9CA3AF',
                            500: '#6B7280',
                            600: '#4B5563',
                            700: '#374151',
                            800: '#1F2937',
                            900: '#111827',
                        },
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01)',
                        'card-hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'nav': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'pulse-subtle': 'pulseSubtle 2s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        pulseSubtle: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.8' },
                        }
                    }
                },
            }
        }
    </script>

    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-balance {
                text-wrap: balance;
            }
            .card-hover-effect {
                @apply transition-all duration-300 hover:shadow-card-hover hover:-translate-y-1;
            }
            .btn-primary-effect {
                @apply bg-primary hover:bg-primary/90 text-white font-medium transition-all duration-300 hover:shadow-md active:shadow-lg active:scale-95;
            }
            .input-focus-effect {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all;
            }
            .tag-effect {
                @apply inline-flex items-center px-3 py-1 rounded-full text-sm font-medium transition-all duration-200 hover:bg-primary hover:text-white;
            }
        }
    </style>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f8fafc;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }

        /* 卡片加载动画 */
        .post-card {
            animation: slideUp 0.5s ease-out forwards;
        }
        .post-card:nth-child(1) { animation-delay: 0.1s; }
        .post-card:nth-child(2) { animation-delay: 0.2s; }
        .post-card:nth-child(3) { animation-delay: 0.3s; }
        .post-card:nth-child(4) { animation-delay: 0.4s; }
        .post-card:nth-child(5) { animation-delay: 0.5s; }
    </style>
{% endblock %}

{% block content %}
{{ render_pagination(pagination) }}
<div class="container mx-auto px-4 py-12 max-w-7xl">
    <!-- 标题和新建按钮 -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 fade-in">
        <div>
            <h1 class="text-[clamp(2rem,5vw,2.8rem)] font-bold text-neutral-800 mb-3 flex items-center">
                <i class="fa fa-comments text-primary mr-4 text-[clamp(2rem,5vw,2.8rem)] animate-pulse-subtle"></i>
                Community Forum
            </h1>
            <p class="text-neutral-600 text-lg md:text-xl max-w-2xl text-balance">
                Connect with fellow enthusiasts, share insights, and engage in meaningful discussions
            </p>
        </div>
        <a href="{{ url_for('forum.create_post') }}" class="mt-6 md:mt-0 btn-primary-effect px-6 py-3 rounded-lg shadow-md flex items-center">
            <i class="fa fa-plus mr-2"></i> New Post
        </a>
    </div>

    <!-- 搜索面板 -->
    <div class="bg-white rounded-2xl shadow-card p-6 md:p-8 mb-10 card-hover-effect">
        <form method="get" action="{{ url_for('forum.index') }}" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- 关键词搜索 -->
                <div>
                    <label for="keyword" class="block text-sm font-medium text-neutral-700 mb-2">Search posts</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-neutral-400">
                            <i class="fa fa-search"></i>
                        </span>
                        <input type="text" id="keyword" name="keyword" class="w-full pl-12 pr-4 py-3 border border-neutral-300 rounded-lg input-focus-effect"
                               placeholder="Title, content, or tags..." value="{{ search_params.keyword }}">
                    </div>
                </div>

                <!-- 作者筛选 -->
                <div>
                    <label for="author_id" class="block text-sm font-medium text-neutral-700 mb-2">Author</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-neutral-400">
                            <i class="fa fa-user"></i>
                        </span>
                        <input type="text" id="author_id" name="author_id" class="w-full pl-12 pr-4 py-3 border border-neutral-300 rounded-lg input-focus-effect"
                               placeholder="UserID" value="{{ search_params.author_id }}">
                    </div>
                </div>

                <!-- 作者筛选2 -->
                <div>
                    <label for="author_name" class="block text-sm font-medium text-neutral-700 mb-2">Author</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-neutral-400">
                            <i class="fa fa-user"></i>
                        </span>
                        <input type="text" id="author_name" name="author_name" class="w-full pl-12 pr-4 py-3 border border-neutral-300 rounded-lg input-focus-effect"
                               placeholder="UserName" value="{{ search_params.author_name }}">
                    </div>
                </div>

                <!-- 日期范围 -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label for="start_date" class="block text-sm font-medium text-neutral-700">Start date</label>
                        <label for="end_date" class="block text-sm font-medium text-neutral-700">End date</label>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-neutral-400">
                                <i class="fa fa-calendar"></i>
                            </span>
                            <input type="date" id="start_date" name="start_date" class="w-full pl-12 pr-4 py-3 border border-neutral-300 rounded-lg input-focus-effect"
                                   value="{{ search_params.start_date }}" placeholder="Start date">
                        </div>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-neutral-400">
                                <i class="fa fa-calendar"></i>
                            </span>
                            <input type="date" id="end_date" name="end_date" class="w-full pl-12 pr-4 py-3 border border-neutral-300 rounded-lg input-focus-effect"
                                   value="{{ search_params.end_date }}" placeholder="End date">
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="flex items-end">
                    <button type="submit" class="w-full btn-primary-effect flex items-center justify-center">
                        <i class="fa fa-filter mr-2"></i> Filter results
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- 帖子列表 -->
    <div class="space-y-8">
        {% for post in posts %}
        <div class="bg-white rounded-2xl shadow-card p-6 md:p-8 card-hover-effect post-card">
            <!-- 帖子头部：标题和用户信息 -->
            <div class="mb-6">
                <h3 class="text-xl md:text-2xl font-bold text-neutral-800 mb-3">
                    <a href="{{ url_for('forum.view_post', post_id=post._id) }}" class="hover:text-primary transition-colors duration-300">
                        {{ post.title }}
                    </a>
                    {% if post.created_at.date() == datetime.utcnow().date() %}
                    <span class="inline-flex items-center ml-3 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 animate-pulse-subtle">
                        <i class="fa fa-dot-circle-o text-green-500 text-[8px] mr-1"></i> New
                    </span>
                    {% endif %}
                </h3>

                <!-- 用户名和日期 -->
                <div class="flex flex-col md:flex-row md:items-center justify-between">
                    <div class="flex items-center space-x-3 mb-3 md:mb-0">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                            <i class="fa fa-user text-xs"></i>
                        </div>
                        <div>
                            <a href="{{ url_for('forum.user_posts', identifier=post.author_name or post.author_id) }}"
                               class="text-neutral-700 font-medium hover:text-primary transition-colors"
                               data-author-id="{{ post.author_id }}"
                               data-author-name="{{ post.author_name }}">
                                {{ post.author_name or post.author_id|truncate(10) }}

<!--                            <a href="{{ url_for('forum.index', author_id=post.author_id) }}" class="text-neutral-700 font-medium hover:text-primary transition-colors">-->
<!--                                {{ post.author_id|truncate(10) }}-->
                            </a>
                            <p class="text-sm text-neutral-500">
                                <i class="fa fa-clock-o mr-1 text-xs"></i>
                                {{ post.created_at.strftime("%Y-%m-%d %H:%M") }}
                                {% if post.updated_at %}
                                    <span class="mx-2">•</span>
                                    <span class="text-neutral-500">Updated: {{ post.updated_at.strftime("%Y-%m-%d") }}</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- 删除按钮 -->
                    {% if post.author_id == current_user_id %}
                    <div class="mt-3 md:mt-0">
                        <div class="dropdown relative">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle flex items-center justify-center w-8 h-8 text-neutral-500 hover:text-red-500 transition-colors"
                                    type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fa fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-1 z-10 border-0">
                                <li>
                                    <form action="{{ url_for('forum.delete_post', post_id=post._id) }}" method="POST" class="d-inline">
                                        <button type="submit" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors"
                                                onclick="return confirm('Delete this post permanently? This action cannot be undone.')">
                                            <i class="fa fa-trash mr-2 text-red-500"></i> Delete post
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 帖子内容 -->
            <p class="text-neutral-700 mb-6 leading-relaxed">
                {{ post.content|truncate(200) }}
            </p>

            <!-- 标签展示 -->
            {% if post.tags %}
            <div class="flex flex-wrap gap-2 mb-6">
                {% for tag in post.tags %}
                <span class="tag-effect bg-neutral-100 text-neutral-700">
                    <i class="fa fa-tag mr-1 text-neutral-500"></i>{{ tag }}
                </span>
                {% endfor %}
            </div>
            {% endif %}

            <!-- 底部交互区 -->
            <div class="pt-6 border-t border-neutral-100">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center space-x-6">
                        <button class="flex items-center text-neutral-500 hover:text-primary transition-colors duration-300">
                            <i class="fa fa-thumbs-up mr-1.5"></i>
                            <span>12</span>
                        </button>
                        <button class="flex items-center text-neutral-500 hover:text-primary transition-colors duration-300">
                            <i class="fa fa-comment-o mr-1.5"></i>
                            <span>4</span>
                        </button>
                    </div>
                    <a href="{{ url_for('forum.view_post', post_id=post._id) }}" class="text-primary hover:text-primary/80 font-medium transition-colors duration-300 flex items-center">
                        Read more
                        <i class="fa fa-arrow-right ml-1.5 text-sm"></i>
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        <div class="bg-white rounded-2xl shadow-card p-8 text-center fade-in">
            <div class="mb-6 text-6xl text-neutral-200">
                <i class="fa fa-comments-o"></i>
            </div>
            <h3 class="text-xl md:text-2xl font-bold text-neutral-800 mb-4">No posts found</h3>
            <p class="text-neutral-600 mb-8 max-w-md mx-auto">
                Looks like there are no posts matching your criteria. Be the first to start a discussion!
            </p>
            <a href="{{ url_for('forum.create_post') }}" class="btn-primary-effect px-8 py-3 rounded-lg shadow-md flex items-center mx-auto">
                <i class="fa fa-plus mr-2"></i> Create new post
            </a>
        </div>
        {% endfor %}
    </div>

    <!-- 分页导航 -->
    {% if pagination.total_pages > 1 %}
    <nav class="mt-12 fade-in">
        <ul class="inline-flex rounded-md shadow-sm">
            <!-- 上一页按钮 -->
            <li>
                <a href="{{ build_url(1) }}" class="relative inline-flex items-center px-4 py-2.5 rounded-l-md border border-neutral-300 bg-white text-sm font-medium text-neutral-500 hover:bg-neutral-50 transition-colors duration-300">
                    <span class="sr-only">First page</span>
                    <i class="fa fa-angle-double-left"></i>
                </a>
            </li>
            <li>
                <a href="{{ build_url(pagination.page - 1) }}" class="relative inline-flex items-center px-4 py-2.5 border border-neutral-300 bg-white text-sm font-medium text-neutral-500 hover:bg-neutral-50 transition-colors duration-300">
                    <span class="sr-only">Previous page</span>
                    <i class="fa fa-angle-left"></i>
                </a>
            </li>

            <!-- 页码范围显示优化 -->
            {% set start_page = max(1, pagination.page - 2) %}
            {% set end_page = min(pagination.total_pages, pagination.page + 2) %}

            {% if start_page > 1 %}
                <li>
                    <span class="relative inline-flex items-center px-4 py-2.5 border border-neutral-300 bg-white text-sm font-medium text-neutral-500">
                        ...
                    </span>
                </li>
            {% endif %}

            {% for p in range(start_page, end_page + 1) %}
                <li>
                    <a href="{{ build_url(p) }}" class="relative inline-flex items-center px-4 py-2.5 border border-neutral-300 bg-white text-sm font-medium {% if p == pagination.page %}bg-primary text-white border-primary{% else %}text-neutral-700 hover:bg-neutral-50{% endif %} transition-colors duration-300">
                        {{ p }}
                    </a>
                </li>
            {% endfor %}

            {% if end_page < pagination.total_pages %}
                <li>
                    <span class="relative inline-flex items-center px-4 py-2.5 border border-neutral-300 bg-white text-sm font-medium text-neutral-500">
                        ...
                    </span>
                </li>
            {% endif %}

            <!-- 下一页按钮 -->
            <li>
                <a href="{{ build_url(pagination.page + 1) }}" class="relative inline-flex items-center px-4 py-2.5 border border-neutral-300 bg-white text-sm font-medium text-neutral-500 hover:bg-neutral-50 transition-colors duration-300">
                    <span class="sr-only">Next page</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
            <li>
                <a href="{{ build_url(pagination.total_pages) }}" class="relative inline-flex items-center px-4 py-2.5 rounded-r-md border border-neutral-300 bg-white text-sm font-medium text-neutral-500 hover:bg-neutral-50 transition-colors duration-300">
                    <span class="sr-only">Last page</span>
                    <i class="fa fa-angle-double-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <div class="text-center text-neutral-500 text-sm mt-4 fade-in">
        Showing {{ posts|length }} of {{ pagination.total }} posts
        (Page {{ pagination.page }} of {{ pagination.total_pages }})
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.querySelector('form').addEventListener('submit', function(e) {
    const authorInput = document.getElementById('author_id');
    const newForm = document.createElement('form');

    // 复制原表单数据
    newForm.method = 'GET';
    newForm.action = this.action;

    // 处理所有参数
    Array.from(this.elements).forEach(el => {
        if (!el.name || el.disabled) return;

        // 特殊处理author_id参数
        if (el.name === 'author_id' && el.value) {
            const isNumeric = /^\d+$/.test(el.value);
            const newInput = document.createElement('input');
            newInput.type = 'hidden';
            newInput.name = isNumeric ? 'author_id' : 'author_name'; // 智能切换参数名
            newInput.value = el.value;
            newForm.appendChild(newInput);
        }
        // 保留其他参数
        else if (el.name !== 'author_id') {
            const newInput = document.createElement('input');
            newInput.type = 'hidden';
            newInput.name = el.name;
            newInput.value = el.value;
            newForm.appendChild(newInput);
        }
    });
    // 提交新表单
    document.body.appendChild(newForm);
    newForm.submit();
    e.preventDefault();
});
          document.addEventListener('DOMContentLoaded', function() {
    // 处理作者链接点击
    document.querySelectorAll('a[data-author-id]').forEach(link => {
        link.addEventListener('click', function(e) {
            // 优先使用author_name，不存在时使用author_id
            if(!this.getAttribute('data-author-name')) {
                e.preventDefault();
                const authorId = this.getAttribute('data-author-id');
                window.location.href = `/forum/posts/user/${authorId}`;
            }
        });
    });
    // 增强搜索框
    const authorSearch = document.getElementById('author_id');
    if(authorSearch) {
        authorSearch.addEventListener('keyup', debounce(function(e) {
            const query = e.target.value.trim();
            if(query.length > 2) {
                fetch(`/api/users/search?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(users => showUserSuggestions(users));
            }
        }, 300));
    }
});
function showUserSuggestions(users) {
    // 实现用户搜索建议展示
}
function debounce(func, wait) {
    let timeout;
    return function() {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, arguments), wait);
    };
}
        // 日期输入框增强
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化日期输入框
            const dateInputs = document.querySelectorAll('.search-form input[type="date"]');
            dateInputs.forEach(input => {
                // 默认显示为文本类型
                if (!input.value) input.type = 'text';

                input.addEventListener('focus', function() {
                    this.type = 'date';
                    if (!this.value) {
                        // 默认选择今天
                        const today = new Date().toISOString().split('T')[0];
                        this.value = today;
                    }
                });

                input.addEventListener('blur', function() {
                    if (!this.value) {
                        this.type = 'text';
                    }
                });
            });

            // 清除搜索条件
            const clearFilters = document.createElement('button');
            clearFilters.className = 'mt-2 text-sm text-primary hover:underline transition-colors';
            clearFilters.innerHTML = '<i class="fa fa-times mr-1"></i> Clear filters';
            clearFilters.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('keyword').value = '';
                document.getElementById('author_id').value = '';
                document.getElementById('start_date').value = '';
                document.getElementById('end_date').value = '';
                document.querySelector('form').submit();
            });
            const searchCard = document.querySelector('.search-card');
            if (searchCard) {
                searchCard.querySelector('.card-body').appendChild(clearFilters);
            }

            // 导航栏滚动效果
            const nav = document.querySelector('nav');
            if (nav) {
                window.addEventListener('scroll', function() {
                    if (window.scrollY > 10) {
                        nav.classList.add('nav-scrolled', 'shadow-nav');
                    } else {
                        nav.classList.remove('nav-scrolled', 'shadow-nav');
                    }
                });
            }
        });
        document.querySelector('form').addEventListener('submit', function(e) {
    const authorInput = document.getElementById('author_id');
    const inputValue = authorInput.value.trim();


    </script>
{% endblock %}
